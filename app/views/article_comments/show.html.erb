<div class="container">
  <div class="row">
    <div class="col-md-5">
      <p><%= @article_comment.created_at.strftime("%Y年%-m月%-d日 %-H時%-M分") %></p>
      <h4>コメント本文</h4>
      <div class="my-4"><%= @article_comment.body %></div>
      <p>by &nbsp <%= link_to @article_comment.member.name, member_path(@article_comment.member) %></p>


      <!--「コメントに対してユーザが評価済みか否か」で条件分岐させる。*自分のコメントには評価できない-->
      <% if @article_comment.rated_by?(current_member) && @article_comment.member != current_member %>
        <%= form_with model: @rating, url: article_article_comment_ratings_path(@article_comment.article_id, @article_comment.id), method: :patch, local:true do |f| %>
          <div class="star-form-group" id="star-update">  <!--空タグ。idで識別子を付与することがポイント。-->
            <%= f.label :rate, "こちらのコメントは参考になりましたか？" %>
            <%= f.hidden_field :rate, id: "rate" %>
          </div>
          <%= f.submit "評価する", class: 'btn btn-sm btn-danger' %>
        <% end %>

        <% @rated = Rating.find_by(member_id: current_member, article_comment_id: @article_comment) %>

        <script>
          $('#star-rate-<%= @article_comment.id %>').empty(); //星評価用の画像をリセットする。こうすることでブラウザバック時の画像を二重読み込みを防げる。
          $("#star-update").raty({
            size: 28,                                      //星のサイズ
            starOff:  '<%= asset_path('star-off.png') %>', //imagesフォルダより星画像の呼び出し
            starOn : '<%= asset_path('star-on.png') %>',
            starHalf: '<%= asset_path('star-half.png') %>',
            half: true,                                    //星半分を許可する。DBには0.5単位の数値が保存される
            score: <%= @rated.rate %>,                     ///scoreオプションで前回の評価内容を取得
            scoreName: 'rating[rate]',                     //ratingモデルのrateカラムに保存
          });
        </script>

      <!--評価をまだ付けていない場合↓  -->
      <% elsif @article_comment.member != current_member %>
        <%= form_with model: @rating, url: article_article_comment_ratings_path(@article_comment.article_id, @article_comment.id), method: :post, local:true do |f| %>
          <div class="star-form-group" id="star">   <!--空タグ。idで識別子を付与することがポイント。-->
            <%= f.label :rate, "こちらのコメントは参考になりましたか？" %>
            <%= f.hidden_field :rate, id: "rate" %>
          </div>
          <%= f.submit "評価する", class: 'btn btn-sm btn-danger' %>
        <% end %>

        <script>
          $("#star").raty({
            size: 12,                                      //星のサイズ
            starOff:  '<%= asset_path('star-off.png') %>', //imagesフォルダより星画像の呼び出し
            starOn : '<%= asset_path('star-on.png') %>',
            starHalf: '<%= asset_path('star-half.png') %>',
            half: true,                                    //星半分を許可する。DBには0.5単位の数値が保存される
            scoreName: 'rating[rate]',                     //ratingモデルのrateカラムに保存
          });
        </script>
      <% end %>
    </div>
    <div class="col-md-5">
      <% if @article_comment.image %>
        <p>添付画像</p>
        <%= attachment_image_tag(@article_comment, :image, :fill, 400, 500, format: 'png') %>
      <% end %>
    </div>
    <div class="col-lg-2 col-md-4 col-sm-8 side-bar">
      <%= render 'members/info', member: current_member %>
    </div>
  </div>
</div>




